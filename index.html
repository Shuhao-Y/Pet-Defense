<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pet Defense v2.2 ‚Äî All Features</title>
<style>
  :root{
    --bg:#071022; --panel:#0b1624; --accent:#34d399; --muted:#97a6b3;
    --rarity-common:#9ca3af; --rarity-uncommon:#34d399; --rarity-rare:#ef4444; --rarity-epic:#7c3aed; --rarity-legend:#f59e0b;
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#071022,#05121a);color:#e6eef6}
  .wrap{display:flex;gap:12px;max-width:1200px;margin:12px auto;padding:12px;}
  .game{background:linear-gradient(180deg,#081528,#06101a);border-radius:12px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,.6);position:relative;}
  canvas{display:block;background:#0b2030;border-radius:8px}
  .sidebar{width:340px;padding:12px;background:linear-gradient(180deg,#071021,#06121a);border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.5)}
  h1{margin:0 0 8px 0;font-size:18px}
  .hud{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .stat{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;min-width:80px;text-align:center}
  button{appearance:none;background:var(--accent);border:none;color:#042018;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}
  .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .small{padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);color:#dff3ea}
  .msg{margin-top:10px;padding:8px;border-radius:8px;background:rgba(0,0,0,0.15)}
  .bottom-right-btn{position:fixed;right:18px;bottom:18px;z-index:1200}
  .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:1300}
  .modal{width:760px;max-width:95%;background:linear-gradient(180deg,#071b25,#041019);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 20px 60px rgba(0,0,0,0.6);color:#ecfdf5}
  .shop-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-height:360px;overflow:auto;padding:6px}
  .pet-card{background:rgba(255,255,255,0.03);padding:8px;border-radius:10px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:transform .12s}
  .pet-card:hover{transform:translateY(-6px)}
  .pet-emoji{font-size:28px}
  .pet-name{font-weight:800}
  .pet-meta{font-size:12px;color:var(--muted)}
  .rarity-common{border:2px solid var(--rarity-common)}
  .rarity-uncommon{border:2px solid var(--rarity-uncommon)}
  .rarity-rare{border:2px solid var(--rarity-rare)}
  .rarity-epic{border:2px solid var(--rarity-epic)}
  .rarity-legend{border:2px solid var(--rarity-legend)}
  .details{display:flex;gap:12px;padding:8px;margin-top:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .detail-stats{font-size:13px;color:#e9f8f2}
  .placement-hint{color:var(--muted);font-size:13px;margin-top:8px}
  .summary{margin-top:12px;color:var(--muted)}
  .unlock-overlay{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;display:flex;align-items:center;justify-content:center;z-index:1500}
  .unlock-box{background:linear-gradient(90deg,rgba(255,255,255,0.07),rgba(255,255,255,0.03));padding:18px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.6);display:flex;align-items:center;gap:12px;backdrop-filter:blur(4px)}
  .sparkle{position:absolute;width:10px;height:10px;border-radius:50%;background:#fff;filter:blur(1px);opacity:0.9}
  .range-circle{position:absolute;border-radius:50%;pointer-events:none;border:2px dashed rgba(255,255,255,0.18)}
  .save-row{display:flex;gap:6px;margin-top:8px}
  .save-slot{flex:1;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="game" id="gameWrap">
    <canvas id="gameCanvas" width="960" height="560"></canvas>
    <div id="rangeCircle" class="range-circle" style="display:none;z-index:500;"></div>
  </div>

  <div class="sidebar">
    <h1>Pet Defense v2.2 ‚Äî All Features</h1>
    <div class="hud">
      <div class="stat">Coins<br><strong id="coins">60</strong></div>
      <div class="stat">Lives<br><strong id="lives">12</strong></div>
      <div class="stat">Wave<br><strong id="wave">0 / 20</strong></div>
    </div>

    <div class="muted">Controls</div>
    <div class="controls">
      <button id="nextWaveBtn">Start Next Wave</button>
      <button id="skipBtn" class="small">End Wave (skip)</button>
      <button id="restartBtn" class="small">Restart</button>
    </div>

    <div class="msg" id="message">Tip: Buy pets in the Shop (bottom-right). Click a pet to drag & place. ESC cancels placement. Save using the slots below.</div>

    <div class="summary" id="summaryBox"></div>

    <div style="margin-top:10px">
      <div style="font-weight:700;margin-bottom:6px">Save / Load (local)</div>
      <div class="save-row">
        <div class="save-slot" id="slot1">Slot 1<br><button class="small" onclick="saveSlot(1)">Save</button> <button class="small" onclick="loadSlot(1)">Load</button></div>
        <div class="save-slot" id="slot2">Slot 2<br><button class="small" onclick="saveSlot(2)">Save</button> <button class="small" onclick="loadSlot(2)">Load</button></div>
        <div class="save-slot" id="slot3">Slot 3<br><button class="small" onclick="saveSlot(3)">Save</button> <button class="small" onclick="loadSlot(3)">Load</button></div>
      </div>
      <div style="margin-top:8px"><button class="small" onclick="clearSaves()">Clear All Saves</button></div>
    </div>
  </div>
</div>

<div class="bottom-right-btn">
  <button id="openShopBtn">Shop üõçÔ∏è</button>
</div>

<div id="shopModalContainer" style="display:none;"></div>
<div id="unlockOverlay" style="display:none;"></div>

<script>
// ------------------------------
// Pet Defense v2.2 (all features)
// Single-file prototype
// ------------------------------
/* Globals & defs */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const PATH = makePath();
const MAX_WAVES = 20;
let animHandle = null;

/* Utility */
const rand = (a,b)=>Math.random()*(b-a)+a;
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const dist = (a,b)=>Math.hypot(a.x-b.x, a.y-b.y);

/* Rarity unlock chances */
const RARITY_UNLOCK = {common:0.85, uncommon:0.5, rare:0.25, epic:0.10, legendary:0.03};

/* Pet definitions */
const PET_DEFS = [
  {id:'cat', emoji:'üê±', name:'Cat', rarity:'common', cost:20, hp:60, dmg:8, speed:3.8, range:80, ability:null, desc:'Starter ‚Äî very fast'},
  {id:'dog', emoji:'üê∂', name:'Dog', rarity:'common', cost:25, hp:80, dmg:10, speed:3.1, range:90, ability:null, desc:'Starter ‚Äî balanced fast'},
  {id:'penguin', emoji:'üêß', name:'Penguin', rarity:'uncommon', cost:60, hp:70, dmg:6, speed:2.2, range:100, ability:'freeze', desc:'Freezes enemies briefly (0.9s)'},
  {id:'dragon', emoji:'üêâ', name:'Dragon', rarity:'rare', cost:120, hp:120, dmg:18, speed:1.4, range:140, ability:'burn', desc:'Burn DOT for 4s'},
  {id:'tiger', emoji:'üêØ', name:'Tiger', rarity:'rare', cost:110, hp:90, dmg:14, speed:2.6, range:70, ability:'bleed', desc:'Bleed DOT 3s'},
  {id:'fox', emoji:'ü¶ä', name:'Fox', rarity:'uncommon', cost:70, hp:60, dmg:9, speed:4.0, range:70, ability:'dash', desc:'Very fast; short dash attacks'},
  {id:'elephant', emoji:'üêò', name:'Elephant', rarity:'epic', cost:150, hp:220, dmg:8, speed:0.9, range:110, ability:'shield', desc:'Shields nearby pets'},
  {id:'owl', emoji:'ü¶â', name:'Owl', rarity:'rare', cost:130, hp:70, dmg:6, speed:1.9, range:130, ability:'reveal', desc:'Reveals invisible ghosts inside range'},
  {id:'axolotl', emoji:'ü¶é', name:'Axolotl', rarity:'uncommon', cost:80, hp:110, dmg:6, speed:1.7, range:80, ability:'regen', desc:'Regenerates health faster'},
  {id:'eel', emoji:'üêü', name:'Electric Eel', rarity:'epic', cost:160, hp:90, dmg:12, speed:1.6, range:100, ability:'stun', desc:'Shocks & stuns'},
  {id:'beetle', emoji:'ü™≤', name:'Bombardier', rarity:'rare', cost:140, hp:80, dmg:6, speed:1.5, range:110, ability:'acid', desc:'Acid spray DOT area'},
  {id:'lyrebird', emoji:'ü™∂', name:'Lyrebird', rarity:'epic', cost:170, hp:75, dmg:0, speed:2.7, range:60, ability:'mimic', desc:'Mimics enemy attack'},
  {id:'pig', emoji:'üê∑', name:'Pig', rarity:'uncommon', cost:90, hp:100, dmg:4, speed:1.8, range:80, ability:'bonusCoins', desc:'More coins per kill'},
  {id:'tardigrade', emoji:'üõ∏', name:'Tardigrade', rarity:'legendary', cost:999, hp:700, dmg:80, speed:1.4, range:130, ability:'tard', desc:'Legendary tank ‚Äî huge stats'}
];

/* Enemy defs */
const ENEMY_DEFS = [
  {id:'grunt', emoji:'üëæ', name:'Grunt', hp:30, speed:1.1, reward:6, unlocks:['dog','cat'], rarity:'common'},
  {id:'ice', emoji:'‚ùÑÔ∏è', name:'Ice Golem', hp:60, speed:0.8, reward:10, unlocks:['penguin'], rarity:'uncommon'},
  {id:'fire', emoji:'üî•', name:'Flame', hp:80, speed:0.85, reward:12, unlocks:['dragon'], rarity:'rare'},
  {id:'bleeder', emoji:'ü©∏', name:'Bleeder', hp:70, speed:1.2, reward:11, unlocks:['tiger'], rarity:'rare'},
  {id:'ghost', emoji:'üëª', name:'Ghost', hp:40, speed:1.3, reward:8, unlocks:['owl'], rarity:'uncommon', invisible:true},
  {id:'fast', emoji:'‚ö°', name:'Runner', hp:40, speed:1.9, reward:9, unlocks:['fox'], rarity:'uncommon'},
  {id:'tank', emoji:'ü™®', name:'Tank', hp:220, speed:0.6, reward:22, unlocks:['elephant'], rarity:'epic'},
  {id:'electric', emoji:'‚ö°üêü', name:'Shock', hp:100, speed:1.0, reward:15, unlocks:['eel'], rarity:'epic'},
  {id:'acid', emoji:'üß™', name:'Spitter', hp:90, speed:0.9, reward:14, unlocks:['beetle'], rarity:'rare'},
  {id:'mimic', emoji:'ü™∂üëæ', name:'Mimic', hp:85, speed:1.1, reward:14, unlocks:['lyrebird'], rarity:'epic'},
  {id:'piggy', emoji:'üê∑', name:'Coin Hog', hp:60, speed:1.0, reward:18, unlocks:['pig'], rarity:'rare'},
  {id:'tardi', emoji:'üõ∏', name:'Ancient Tardi', hp:400, speed:0.7, reward:120, unlocks:['tardigrade'], rarity:'legendary'}
];

/* Rarity colors */
const RARITY_COLORS = {
  common: '#9ca3af', uncommon: '#34d399', rare: '#ef4444', epic: '#7c3aed', legendary: '#f59e0b'
};

/* Game state */
const GAME = {
  coins: 60,
  lives: 12,
  wave: 0,
  waveConfig: [],
  enemies: [],
  pets: [],
  projectiles: [],
  betweenWaves: true,
  isSpawning: false,
  unlocked: {},
  placement: null, // {def, dragging: true}
  lastTime: performance.now()
};

/* init unlocked */
PET_DEFS.forEach(p => GAME.unlocked[p.id] = (p.id==='cat' || p.id==='dog'));

/* Generate waves */
function generateWaves(n){
  const waves=[];
  for(let i=0;i<n;i++){
    const arr=[];
    const count = 6 + i*2;
    for(let k=0;k<count;k++){
      const r=Math.random();
      if(i>=6 && r<0.03) arr.push('tardi');
      else if(r<0.08) arr.push('tank');
      else if(r<0.18) arr.push('fire');
      else if(r<0.28) arr.push('ice');
      else if(r<0.38) arr.push('bleeder');
      else if(r<0.48 && i>=4) arr.push('ghost'); // ghosts only if wave >=5 (i index >=4)
      else if(r<0.6) arr.push('fast');
      else if(r<0.68) arr.push('acid');
      else if(r<0.75) arr.push('piggy');
      else arr.push('grunt');
    }
    waves.push(arr);
  }
  return waves;
}

/* Path */
function makePath(){
  return [
    {x:-40,y:280},
    {x:140,y:280},
    {x:140,y:80},
    {x:440,y:80},
    {x:440,y:420},
    {x:760,y:420},
    {x:1020,y:320}
  ];
}

/* UI helpers */
const coinsEl = document.getElementById('coins');
const livesEl = document.getElementById('lives');
const waveEl = document.getElementById('wave');
const messageEl = document.getElementById('message');
const summaryEl = document.getElementById('summaryBox');
const rangeEl = document.getElementById('rangeCircle');

function updateUI(){
  coinsEl.innerText = Math.floor(GAME.coins);
  livesEl.innerText = GAME.lives;
  waveEl.innerText = `${GAME.wave} / ${MAX_WAVES}`;
  buildSummary();
}

/* Summary/hide locked pets */
function buildSummary(){
  const total = PET_DEFS.length;
  const unlockedCount = PET_DEFS.filter(p => GAME.unlocked[p.id]).length;
  const remaining = total - unlockedCount;
  const breakdown = PET_DEFS.reduce((a,p)=>{
    if(!GAME.unlocked[p.id]) a[p.rarity] = (a[p.rarity]||0) + 1;
    return a;
  }, {});
  summaryEl.innerHTML = `You have unlocked <strong>${unlockedCount}</strong> pets. <br>
    <span style="color:var(--muted)">${remaining} remaining ‚Äî common:${breakdown.common||0}, uncommon:${breakdown.uncommon||0}, rare:${breakdown.rare||0}, epic:${breakdown.epic||0}, legendary:${breakdown.legendary||0}</span>`;
}

/* Start / spawn waves */
GAME.waveConfig = generateWaves(MAX_WAVES);

function startNextWave(){
  if(GAME.isSpawning) return flashMsg('Wave already in progress');
  if(!GAME.betweenWaves) return flashMsg('Wave already running');
  if(GAME.wave >= MAX_WAVES) return flashMsg('All waves complete');
  GAME.wave++;
  GAME.isSpawning = true;
  GAME.betweenWaves = false;
  updateUI();
  const enemiesToSpawn = [...GAME.waveConfig[GAME.wave-1]];
  let idx=0;
  const interval = Math.max(700 - GAME.wave*18, 260);
  GAME.spawnTimer = setInterval(()=>{
    if(idx >= enemiesToSpawn.length){
      clearInterval(GAME.spawnTimer);
      GAME.isSpawning = false;
      // check wave clear after short delay
      setTimeout(()=> { if(GAME.enemies.length===0) finishWave(); }, 700);
      return;
    }
    spawnEnemy(enemiesToSpawn[idx++]);
  }, interval);
}

function finishWave(){
  GAME.betweenWaves = true;
  flashMsg('Wave cleared ‚Äî buy pets!');
  updateUI();
}

function skipWave(){
  if(GAME.isSpawning){
    clearInterval(GAME.spawnTimer);
    GAME.isSpawning = false;
    GAME.enemies = [];
    finishWave();
  } else if(GAME.betweenWaves) startNextWave();
}

/* Spawn enemy */
function spawnEnemy(id){
  const ed = ENEMY_DEFS.find(e=>e.id===id) || ENEMY_DEFS[0];
  // ensure ghosts only after wave 4 (wave index 5+)
  if(ed.invisible && GAME.wave < 5){
    // replace with grunt
    id = 'grunt';
  }
  const pos = {...PATH[0]};
  const e = {
    id: ed.id,
    emoji: ed.emoji,
    name: ed.name,
    maxHp: ed.hp,
    hp: ed.hp,
    speed: ed.speed,
    reward: ed.reward,
    x: pos.x + rand(-8,8), y: pos.y + rand(-12,12),
    waypointIndex: 0,
    alive: true,
    invisible: !!ed.invisible,
    slowed: 1,
    burn: 0, bleed:0, stun:0,
    unlocks: ed.unlocks || []
  };
  GAME.enemies.push(e);
}

/* Pet create */
function createPet(def, x,y){
  return {
    id: def.id, emoji: def.emoji, name: def.name, rarity: def.rarity,
    maxHp: def.hp, hp: def.hp, dmg: def.dmg, speed: def.speed, range: def.range, ability: def.ability,
    x,y,vx:0,vy:0,target:null,cooldown:0,regenTimer:0,alive:true
  };
}

/* Shop modal */
document.getElementById('openShopBtn').onclick = openShop;
document.getElementById('nextWaveBtn').onclick = ()=> { if(!GAME.betweenWaves) return flashMsg('Wave in progress'); startNextWave(); };
document.getElementById('skipBtn').onclick = skipWave;
document.getElementById('restartBtn').onclick = ()=> { if(confirm('Restart game?')) resetGame(); };

function openShop(){
  const container = document.getElementById('shopModalContainer');
  container.innerHTML = '';
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal" role="dialog">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">Shop</div>
        <div><button id="closeShopBtn" class="small">Close</button></div>
      </div>
      <div style="margin-top:8px;color:var(--muted)">Click a pet to view details and buy (buy only between waves). Locked pets are hidden here.</div>
      <div class="shop-grid" id="shopGrid"></div>
      <div id="detailPanel"></div>
    </div>
  `;
  container.appendChild(modal);
  container.style.display = 'block';
  document.getElementById('closeShopBtn').onclick = ()=> { container.style.display = 'none'; };

  const grid = modal.querySelector('#shopGrid');
  PET_DEFS.forEach(def => {
    if(!GAME.unlocked[def.id]) return; // hide locked
    const card = document.createElement('div');
    card.className = `pet-card rarity-${def.rarity}`;
    card.style.borderColor = RARITY_COLORS[def.rarity] || RARITY_COLORS.common;
    card.dataset.id = def.id;
    card.innerHTML = `<div class="pet-emoji">${def.emoji}</div>
                      <div style="flex:1">
                        <div class="pet-name">${def.name} <span style="font-size:12px;color:var(--muted)">(${def.rarity})</span></div>
                        <div class="pet-meta">‚ù§Ô∏è ${def.hp} &nbsp; üí• ${def.dmg} &nbsp; ‚ö° ${def.speed.toFixed(1)} &nbsp; üéØ ${def.range}</div>
                      </div>
                      <div style="font-weight:800">${def.cost}¬¢</div>`;
    card.onclick = ()=> showDetail(def);
    grid.appendChild(card);
  });
  if(!grid.querySelector('.pet-card')) grid.innerHTML = '<div style="color:var(--muted)">No pets unlocked yet ‚Äî kill enemies to unlock pets.</div>';
}

/* Show detail and buy -> placement */
function showDetail(def){
  const panel = document.querySelector('#detailPanel');
  panel.innerHTML = `
    <div class="details" style="border-left:6px solid ${RARITY_COLORS[def.rarity]}">
      <div style="font-size:34px">${def.emoji}</div>
      <div style="flex:1">
        <div style="font-weight:900">${def.name} <span style="font-size:12px;color:var(--muted)">(${def.rarity})</span></div>
        <div class="detail-stats">
          ‚ù§Ô∏è Health: ${def.hp} &nbsp; üí• Damage: ${def.dmg} <br>
          ‚ö° Speed: ${def.speed} &nbsp; üéØ Range: ${def.range} <br>
          ‚ú® Ability: ${def.ability || '‚Äî'} &nbsp; ‚Ä¢ ${def.desc || ''}
        </div>
        <div class="placement-hint">Buy to place on map. Drag to position, release to place. Press ESC to cancel.</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div style="font-weight:800">${def.cost}¬¢</div>
        <div>
          <button id="buyThisBtn">Buy & Place</button>
          <button id="cancelBuyBtn" class="small">Cancel</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('buyThisBtn').onclick = ()=>{
    if(!GAME.betweenWaves){ flashMsg('Buy only between waves'); return; }
    if(GAME.coins < def.cost){ flashMsg('Not enough coins'); return; }
    GAME.coins -= def.cost;
    updateUI();
    // enter placement mode
    GAME.placement = {def, dragging:true, x: canvas.width/2, y: canvas.height/2};
    showPlacementRange(def.range);
    document.getElementById('shopModalContainer').style.display = 'none';
    flashMsg(`Placing ${def.name} ‚Äî drag and release to place. ESC to cancel.`);
  };
  document.getElementById('cancelBuyBtn').onclick = ()=> panel.innerHTML = '';
}

/* Placement UI handlers (drag-to-place) */
canvas.addEventListener('mousemove', (ev)=>{
  if(GAME.placement && GAME.placement.dragging){
    const rect = canvas.getBoundingClientRect();
    GAME.placement.x = ev.clientX - rect.left;
    GAME.placement.y = ev.clientY - rect.top;
    rangeEl.style.display = 'block';
    rangeEl.style.width = (GAME.placement.def.range*2) + 'px';
    rangeEl.style.height = (GAME.placement.def.range*2) + 'px';
    rangeEl.style.left = (rect.left + GAME.placement.x - GAME.placement.def.range) + 'px';
    rangeEl.style.top = (rect.top + GAME.placement.y - GAME.placement.def.range) + 'px';
  }
});

canvas.addEventListener('mouseup', (ev)=>{
  if(GAME.placement && GAME.placement.dragging){
    const rect = canvas.getBoundingClientRect();
    const x = GAME.placement.x, y = GAME.placement.y;
    // finalize placement
    const inst = createPet(GAME.placement.def, x, y);
    GAME.pets.push(inst);
    GAME.placement = null;
    rangeEl.style.display = 'none';
    flashMsg('Pet placed!');
  }
});

window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && GAME.placement){
    // cancel placement, refund
    GAME.coins += GAME.placement.def.cost;
    GAME.placement = null;
    rangeEl.style.display = 'none';
    updateUI();
    flashMsg('Placement cancelled and refunded.');
  }
});

/* Pet AI */
function petAI(p, dt){
  // passive regen
  p.regenTimer = (p.regenTimer||0) + dt;
  if(p.regenTimer > 0.9){
    p.regenTimer = 0;
    const base = p.ability==='regen' ? 6 : 1.8;
    p.hp = Math.min(p.maxHp, p.hp + base);
  }
  // choose nearest visible enemy
  let nearest=null, best=Infinity;
  for(const e of GAME.enemies){
    if(!e.alive) continue;
    if(e.invisible && !isRevealedByOwl(p)) continue;
    const d = Math.hypot(e.x - p.x, e.y - p.y);
    if(d < best){ best = d; nearest = e; }
  }
  if(nearest && best <= p.range){
    p.target = nearest;
    // move toward enemy
    const dx = nearest.x - p.x, dy = nearest.y - p.y; const m = Math.hypot(dx,dy)||1;
    const speedMult = (p.ability==='dash') ? 1.6 : 1.0;
    p.vx = (dx/m) * p.speed * speedMult; p.vy = (dy/m) * p.speed * speedMult;
    p.x += p.vx * dt * 60; p.y += p.vy * dt * 60;
    // attack if close
    const reach = 18 + (p.ability==='tard' ? 10 : 0);
    if(Math.hypot(nearest.x-p.x, nearest.y-p.y) < reach && p.cooldown <= 0){
      doPetAttack(p, nearest);
      p.cooldown = (p.ability==='dash') ? 0.35 : 0.6;
    } else p.cooldown -= dt;
  } else {
    p.target = null;
    // idle motion
    p.x += Math.cos((Date.now()/1000) + p.x*0.01) * 0.05;
    p.y += Math.sin((Date.now()/1000) + p.y*0.01) * 0.05;
    p.cooldown -= dt;
  }
  // clamp
  p.x = clamp(p.x, 30, canvas.width-60); p.y = clamp(p.y, 30, canvas.height-40);
}

/* Reveal: any owl alive reveal ghosts globally (simpler) */
function isRevealedByOwl(pet){
  return GAME.pets.some(pp => pp.ability === 'reveal' && Math.hypot(pp.x - (pet?pet.x:0), pp.y - (pet?pet.y:0)) < pp.range + 40);
}

/* Pet attack */
function doPetAttack(pet, enemy){
  enemy.hp -= pet.dmg;
  // special effects
  switch(pet.ability){
    case 'freeze': enemy.slowed = 0.32; setTimeout(()=> enemy.slowed = 1, 900); GAME.projectiles.push({x:enemy.x,y:enemy.y,life:0.9,type:'freeze'}); break;
    case 'burn': enemy.burn += 4; GAME.projectiles.push({x:enemy.x,y:enemy.y,life:1.4,type:'burn'}); break;
    case 'bleed': enemy.bleed += 3; GAME.projectiles.push({x:enemy.x,y:enemy.y,life:1.0,type:'bleed'}); break;
    case 'stun': enemy.stun = Math.max(enemy.stun||0, 0.9); GAME.projectiles.push({x:enemy.x,y:enemy.y,life:0.6,type:'stun'}); break;
    case 'acid': enemy.bleed += 2; for(const e of GAME.enemies) if(e!==enemy && e.alive && Math.hypot(e.x-enemy.x,e.y-enemy.y) < 30) e.bleed +=2; GAME.projectiles.push({x:enemy.x,y:enemy.y,life:1.2,type:'acid'}); break;
    case 'mimic': enemy.hp -= Math.floor(enemy.maxHp*0.02); GAME.projectiles.push({x:enemy.x,y:enemy.y,life:0.9,type:'mimic'}); break;
    case 'bonusCoins': break;
    case 'regen': pet.hp = Math.min(pet.maxHp, pet.hp + 6); break;
    default: break;
  }
  GAME.projectiles.push({x:enemy.x,y:enemy.y,life:0.16});
}

/* Enemy AI */
function enemyAI(e, dt){
  if(e.burn > 0){ e.burn -= dt; e.hp -= 1.2 * dt * 60 * 0.02; }
  if(e.bleed > 0){ e.bleed -= dt; e.hp -= 0.9 * dt * 60 * 0.02; }
  if(e.stun && e.stun > 0) e.stun -= dt;

  if(e.invisible){
    const tx = PATH[PATH.length-1].x, ty = PATH[PATH.length-1].y; const dx = tx - e.x, dy = ty - e.y; const m = Math.hypot(dx,dy)||1;
    if(!(e.stun && e.stun>0)) { e.x += (dx/m)*e.speed*60*dt*e.slowed; e.y += (dy/m)*e.speed*60*dt*e.slowed; }
    if(Math.hypot(tx - e.x, ty - e.y) < 18){ e.alive=false; GAME.lives--; updateUI(); if(GAME.lives<=0) gameOver(); }
  } else {
    const wp = PATH[e.waypointIndex+1] || PATH[PATH.length-1];
    const dx = wp.x - e.x, dy = wp.y - e.y; const m = Math.hypot(dx,dy)||1;
    if(!(e.stun && e.stun>0)) { e.x += (dx/m)*e.speed*40*dt*e.slowed; e.y += (dy/m)*e.speed*40*dt*e.slowed; }
    if(Math.hypot(wp.x - e.x, wp.y - e.y) < 12){
      if(e.waypointIndex < PATH.length - 2) e.waypointIndex++;
      else { e.alive=false; GAME.lives--; updateUI(); if(GAME.lives<=0) gameOver(); }
    }
  }
}

/* Death handling & unlocks */
function handleEnemyDeath(e){
  e.alive=false;
  // drop
  let drop = e.reward + Math.floor(Math.random()*4);
  if(GAME.pets.some(p=>p.ability==='bonusCoins')) drop = Math.floor(drop * 1.25);
  GAME.coins += drop;
  updateUI();
  // unlock attempts
  e.unlocks.forEach(pid=>{
    const def = PET_DEFS.find(p=>p.id===pid);
    if(!def) return;
    if(GAME.unlocked[pid]) return;
    const chance = RARITY_UNLOCK[def.rarity] || 0.05;
    if(Math.random() < chance){
      GAME.unlocked[pid] = true;
      buildSummary(); updateUI();
      showUnlockAnimation(def);
    } else {
      if(Math.random() < 0.08) flashMsg('You almost unlocked something...');
    }
  });
}

/* Visual effects spawn */
function spawnEffect(x,y,type){
  GAME.projectiles.push({x,y,life:1.0,type});
}

/* Unlock animation */
function showUnlockAnimation(def){
  const overlay = document.getElementById('unlockOverlay');
  overlay.innerHTML = '';
  overlay.style.display = 'block';
  overlay.className = 'unlock-overlay';
  const box = document.createElement('div');
  box.className = 'unlock-box';
  box.innerHTML = `<div style="font-size:34px">${def.emoji}</div><div style="font-weight:900">üîì You unlocked ${def.name} <span style="font-size:13px;color:var(--muted)">(${def.rarity})</span></div>`;
  overlay.appendChild(box);
  for(let i=0;i<18;i++){
    const s = document.createElement('div'); s.className='sparkle'; overlay.appendChild(s);
    s.style.left = (50 + (Math.random()*160 - 80)) + '%';
    s.style.top = (50 + (Math.random()*160 - 80)) + '%';
    s.style.background = ['#fff','#ffecb3','#ffd6a5'][Math.floor(Math.random()*3)];
    s.animate([{transform:'translate(-50%,-50%) scale(1)', opacity:1},{transform:`translate(-50%,-50%) scale(0.1)`, opacity:0}], {duration:900+Math.random()*600, easing:'cubic-bezier(.2,.9,.2,1)'});
  }
  setTimeout(()=>{ overlay.style.display='none'; overlay.innerHTML=''; }, 1700);
}

/* Messages */
function flashMsg(txt){
  messageEl.innerText = txt;
  setTimeout(()=>{ if(messageEl.innerText === txt) messageEl.innerText = 'Tip: Buy pets in the Shop (bottom-right)'; }, 3800);
}

/* Main loop */
let last = performance.now();
function loop(){
  const nowt = performance.now();
  const dt = Math.min(0.04, (nowt - last)/1000);
  last = nowt;

  // pets
  for(const p of GAME.pets) petAI(p, dt);

  // enemies
  for(const e of GAME.enemies) {
    if(!e.alive) continue;
    enemyAI(e, dt);
    if(e.hp <= 0) handleEnemyDeath(e);
  }
  GAME.enemies = GAME.enemies.filter(e=>e.alive);

  // projectiles visuals
  for(const p of GAME.projectiles) p.life -= dt;
  GAME.projectiles = GAME.projectiles.filter(p=>p.life>0);

  // detect end of wave
  if(!GAME.isSpawning && GAME.enemies.length===0 && !GAME.betweenWaves && GAME.wave>0){
    finishWave();
  }

  render();
  if(GAME.lives <= 0) { gameOver(); return; }
  animHandle = requestAnimationFrame(loop);
}

/* Render */
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#071c2a'; ctx.fillRect(0,0,canvas.width,canvas.height);
  // path
  ctx.lineWidth = 44; ctx.lineCap='round'; ctx.strokeStyle='#123a4a'; ctx.beginPath(); ctx.moveTo(PATH[0].x, PATH[0].y); for(let i=1;i<PATH.length;i++) ctx.lineTo(PATH[i].x, PATH[i].y); ctx.stroke();
  ctx.lineWidth = 4; ctx.strokeStyle = '#2aa79a'; ctx.beginPath(); ctx.moveTo(PATH[0].x, PATH[0].y); for(let i=1;i<PATH.length;i++) ctx.lineTo(PATH[i].x, PATH[i].y); ctx.stroke();

  // pets
  for(const p of GAME.pets){
    ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(p.x, p.y+10, 18, 10,0,0,Math.PI*2); ctx.fill();
    ctx.font='30px serif'; ctx.globalAlpha = 1; ctx.fillText(p.emoji, p.x-15, p.y+12);
    // hp bar
    const w=48; ctx.fillStyle='#222'; ctx.fillRect(p.x - w/2, p.y - 28, w, 6); ctx.fillStyle = '#ff6b6b'; ctx.fillRect(p.x - w/2, p.y - 28, w * clamp(p.hp/p.maxHp,0,1), 6);
    // ability icon
    ctx.font='12px sans-serif'; if(p.ability) ctx.fillText('‚ú®', p.x + 20, p.y - 18);
  }

  // enemies
  for(const e of GAME.enemies){
    ctx.fillStyle = 'rgba(0,0,0,0.22)'; ctx.beginPath(); ctx.ellipse(e.x, e.y+8, 16, 8,0,0,Math.PI*2); ctx.fill();
    ctx.font='26px serif';
    if(e.invisible && !isRevealedByOwl()) { ctx.globalAlpha = 0.14; ctx.fillText('üëª', e.x-12, e.y+10); ctx.globalAlpha = 1; }
    else ctx.fillText(e.emoji, e.x-12, e.y+10);
    // hp bar
    ctx.fillStyle='#222'; ctx.fillRect(e.x - 20, e.y - 24, 40, 6); ctx.fillStyle = '#9ef01a'; ctx.fillRect(e.x - 20, e.y - 24, 40 * clamp(e.hp/e.maxHp,0,1), 6);
    // status icons
    if(e.burn>0){ ctx.fillStyle='rgba(255,100,40,0.6)'; ctx.fillRect(e.x-10, e.y+12, 8, 4); }
    if(e.bleed>0){ ctx.fillStyle='rgba(160,0,20,0.6)'; ctx.fillRect(e.x+2, e.y+12, 8, 4); }
    if(e.stun>0){ ctx.fillStyle='rgba(255,220,40,0.8)'; ctx.beginPath(); ctx.arc(e.x, e.y-12, 6,0,Math.PI*2); ctx.fill(); }
  }

  // projectiles (visual)
  for(const p of GAME.projectiles){
    const t = Math.max(0, p.life);
    if(p.type === 'freeze'){ ctx.strokeStyle = `rgba(120,200,255,${t})`; ctx.beginPath(); ctx.arc(p.x, p.y, 18 * (1-t), 0, Math.PI*2); ctx.stroke(); }
    else if(p.type === 'burn'){ ctx.fillStyle = `rgba(255,100,30,${t})`; ctx.beginPath(); ctx.arc(p.x + rand(-6,6), p.y + rand(-6,6), 3 + 6*(1-t), 0, Math.PI*2); ctx.fill(); }
    else if(p.type === 'acid'){ ctx.fillStyle = `rgba(160,255,120,${t})`; ctx.beginPath(); ctx.arc(p.x + rand(-10,10), p.y + rand(-10,10), 2 + 6*(1-t), 0, Math.PI*2); ctx.fill(); }
    else if(p.type === 'stun'){ ctx.fillStyle = `rgba(255,240,120,${t})`; ctx.beginPath(); ctx.arc(p.x, p.y-8, 6*(1-t), 0, Math.PI*2); ctx.fill(); }
    else { ctx.fillStyle = `rgba(255,215,80,${t})`; ctx.beginPath(); ctx.arc(p.x, p.y, 3 + 6*(1-t), 0, Math.PI*2); ctx.fill(); }
  }

  // castle
  ctx.fillStyle = '#222'; ctx.fillRect(canvas.width - 64, canvas.height/2 - 64, 56, 128);
  ctx.fillStyle = '#ffd54f'; ctx.font = '20px sans-serif'; ctx.fillText('üè∞', canvas.width - 56, canvas.height/2 + 10);

  // draw placement preview if any
  if(GAME.placement && GAME.placement.dragging){
    ctx.globalAlpha = 0.35;
    ctx.beginPath(); ctx.arc(GAME.placement.x, GAME.placement.y, GAME.placement.def.range, 0, Math.PI*2); ctx.fillStyle = 'rgba(255,255,255,0.02)'; ctx.fill();
    ctx.globalAlpha = 1;
    ctx.font='30px serif'; ctx.fillText(GAME.placement.def.emoji, GAME.placement.x-15, GAME.placement.y+12);
  }
}

/* housekeeping: kill check and auto-heal between waves */
setInterval(()=>{
  for(const e of [...GAME.enemies]) if(e.alive && e.hp <= 0) handleEnemyDeath(e);
  GAME.enemies = GAME.enemies.filter(e=>e.alive);
  if(GAME.betweenWaves){
    for(const p of GAME.pets) p.hp = Math.min(p.maxHp, p.hp + 3);
  }
  updateUI();
}, 600);

/* Game over */
function gameOver(){
  flashMsg('Game Over. Restart to try again.');
  cancelAnimationFrame(animHandle);
}

/* Reset */
function resetGame(){
  GAME.coins = 60; GAME.lives = 12; GAME.wave = 0; GAME.enemies=[]; GAME.pets=[]; GAME.projectiles=[]; GAME.betweenWaves=true; GAME.isSpawning=false;
  PET_DEFS.forEach(p => GAME.unlocked[p.id] = (p.id==='cat' || p.id==='dog'));
  GAME.waveConfig = generateWaves(MAX_WAVES);
  updateUI(); if(!animHandle) animHandle = requestAnimationFrame(loop);
}

/* Save / Load (localStorage) with 3 slots */
function getSaveKey(slot){ return `petdef_save_slot_${slot}`; }
function saveSlot(slot){
  const data = {
    coins: GAME.coins, lives: GAME.lives, wave: GAME.wave, unlocked: GAME.unlocked,
    pets: GAME.pets.map(p => ({id:p.id,x:p.x,y:p.y,hp:p.hp})),
    enemies: GAME.enemies.map(e => ({id:e.id,x:e.x,y:e.y,hp:e.hp,way:e.waypointIndex})),
    betweenWaves: GAME.betweenWaves
  };
  localStorage.setItem(getSaveKey(slot), JSON.stringify(data));
  flashMsg(`Saved to slot ${slot}`);
}
function loadSlot(slot){
  const raw = localStorage.getItem(getSaveKey(slot));
  if(!raw){ flashMsg('No save in that slot'); return; }
  const data = JSON.parse(raw);
  GAME.coins = data.coins; GAME.lives = data.lives; GAME.wave = data.wave; GAME.unlocked = data.unlocked || GAME.unlocked;
  GAME.pets = data.pets.map(s => {
    const def = PET_DEFS.find(p=>p.id===s.id);
    return createPet(def, s.x, s.y);
  });
  GAME.enemies = data.enemies.map(s => {
    const ed = ENEMY_DEFS.find(e=>e.id===s.id);
    return {...ed, x:s.x, y:s.y, hp:s.hp, maxHp:ed.hp, waypointIndex:s.way || 0, alive:true, invisible:!!ed.invisible, slowed:1, burn:0, bleed:0, stun:0, unlocks:ed.unlocks||[]};
  });
  GAME.betweenWaves = !!data.betweenWaves;
  updateUI(); flashMsg(`Loaded slot ${slot}`);
}
function clearSaves(){
  if(!confirm('Clear all save slots?')) return;
  localStorage.removeItem(getSaveKey(1)); localStorage.removeItem(getSaveKey(2)); localStorage.removeItem(getSaveKey(3));
  flashMsg('All saves cleared');
}

/* Shop button & initial UI */
document.getElementById('openShopBtn').onclick = openShop;
updateUI();

/* Start the loop */
animHandle = requestAnimationFrame(loop);

/* Expose some helper functions to the console (for debugging) */
window.GAME = GAME; window.saveSlot = saveSlot; window.loadSlot = loadSlot; window.resetGame = resetGame;

/* End of script */
</script>
</body>
</html>
